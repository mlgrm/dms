version: "3"
services:
#  ocpu:
#    restart: on-failure
#    image: dms-ocpu
#    ports:
#      - "8787"
#    hostname: ocpu
#    #command: apachectl -DFOREGROUND
#    networks:
#      - webproxy
#      - privatenet
#    volumes:
#      - ./rstudio.conf:/etc/apache2/sites-enabled/rstudio.conf
#    environment:
#      # VIRTUAL_PROTO: https
#      VIRTUAL_HOST: dimas.bigend.org
#      LETSENCRYPT_EMAIL: joshua@bigend.io
#      LETSENCRYPT_HOST: "dimas.bigend.org"
#      #HTTPS_METHOD: redirect
#      CERT_NAME: dimas.bigend.org
#      VIRTUAL_PORT: 80

  superset:
    image: amancevice/superset
    restart: always
    ports:
      - "8088"
    volumes: # these need to be owned by uid 1000
      - ./superset/superset_config.py:/etc/superset/superset_config.py
      - ./superset/data/:/var/lib/superset/
    networks:
      - default
      - privatenet
    environment:
      MAPBOX_API_KEY: ${MAPBOX_API_KEY}
      VIRTUAL_HOST: $SS_VIRTUAL_HOST
      LETSENCRYPT_EMAIL: $SS_LETSENCRYPT_EMAIL
      LETSENCRYPT_HOST: $SS_LETSENCRYPT_HOST
      POSTGRES_PASSWORD: $SS_POSTGRES_PASSWORD
      #HTTPS_METHOD: redirect
      CERT_NAME: $SS_CERT_NAME
      VIRTUAL_PORT: 8088
    depends_on:
      - redis
      - postgres
    links:
      - postgres:postgres
      - redis:redis

  redis:
    image: redis
    restart: always
    ports:
      - "6379"
    volumes:
      - redis:/data
    networks:
      - privatenet
  
  postgres:
    image: library/postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: $SS_POSTGRES_DB
      POSTGRES_PASSWORD: $SS_POSTGRES_PASSWORD
      POSTGRES_USER: $SS_POSTGRES_USER
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - default
      - privatenet

  pgadmin:
    image: chorss/docker-pgadmin4
    ports:
      - "5050:5050"
    environment:
      UID: 1000
      GID: 1000
    volumes:
      - ./pgadmin/data:/data/chorss/docker-pgadmin4
    networks:
      - default
      - privatenet

networks:
  privatenet:
  webproxy:
    external:
      name: webproxy
volumes:
  redis:
    external: false
